<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="referrer" content="same-origin">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="feed" href="/feeds/all.atom.xml" title="Articles">

<link rel="canonical" href="http://betatim.github.io/posts/hotwire-turbo-with-python/">
<meta property="og:url" content="http://betatim.github.io/posts/hotwire-turbo-with-python/" />
<meta property="og:type" content="article" />
<meta property="og:title" content="TIL: Hotwire's Turbo with Python" />

    <title>TIL: Hotwire's Turbo with Python - Tim Head's blog</title>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
    <link href="/theme/simplez.css" rel="stylesheet">
    <link href="/theme/pygments/default.css" rel="stylesheet">

    <script>
      // Only load GA if DNT is not set
      if (navigator.doNotTrack != "1" && // Most Firefox & Chrome
          window.doNotTrack != "1" && // IE & Safari
          navigator.msDoNotTrack != "1" // Old IE
      ) {
        console.log("Loading Google Analytics, since Do Not Track is off");
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-49540142-1', 'betatim.github.io', {'storage': 'none'});
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
      }
    </script>

    <script>
    window.MathJax = {
      tex: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        autoload: {
          color: [],
          colorV2: ['color']
        },
        packages: {'[+]': ['noerrors']}
      },
      chtml: {
        displayAlign: 'left'    // Change this to 'center' to center equations.
      },
      options: {
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process'
      },
      loader: {
        load: ['[tex]/noerrors']
      }
    };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/tex-mml-chtml.js"></script>


  </head>
  <body>
    <div class="container">
      <div class="row justify-content-center pb-5">
        <div class="col-md-8 px-0">
          <nav class="navbar navbar-expand-lg navbar-light bg-white">
            <a class="navbar-brand" href="http://betatim.github.io/">Tim<b>Head</b></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav">

                  <li class="nav-item ">
                    <a class="nav-link" href="/pages/about">
                      About Me
                     </a>
                  </li>
              </ul>
            </div>
          </nav>
        </div>
      </div>

      <div class="row justify-content-center pb-5">
        <div class="col-md-8">
<article>
  <header class="title">
    <h1>
      TIL: Hotwire's Turbo with Python
    </h1>
    <time class="when d-block small mb-3">25 April 2021</time>
  </header>
  <article>
    <p><a href="https://turbo.hotwire.dev/handbook/streams">Hotwire's Turbo Streams</a> can use
WebSockets to stream updates. How to do this is not well documented in the
handbook. This post contains my notes on building a prototype to figure out
how to do it. I used Tornado as webserver but the technique is completely
backend agnostic.</p>
<h2>What are Turbo Streams?</h2>
<p>Turbo Streams allow you to send small fragments of HTML and replace parts of
the page with that new HTML. An example of a fragment you can send:</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;turbo-stream</span> <span class="na">action=</span><span class="s">&quot;append&quot;</span> <span class="na">target=</span><span class="s">&quot;messages&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;template&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;message_1&quot;</span><span class="nt">&gt;</span>
      This div will be appended to the element with the DOM ID &quot;messages&quot;.
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/template&gt;</span>
<span class="nt">&lt;/turbo-stream&gt;</span>
</pre></div>


<h2>My setup</h2>
<p>I wanted to build a web page that allows the user to submit a file for
processing and then retrieve their processed file once it is ready. For this
it would be nice to show a spinner or some kind of progress bar to the user
while the file is being worked on.</p>
<p>The form itself is a standard HTML form. It sends the form contents to <code>/convert</code>
using a POST request. The response is a HTTP status 303 redirect to <code>/status/&lt;job_id&gt;</code>.</p>
<p>The status page contains the following piece of JS in its <code>&lt;head&gt;</code> tag:</p>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="o">&gt;</span>
  <span class="kn">import</span> <span class="p">{</span> <span class="n">connectStreamSource</span> <span class="p">}</span> <span class="kn">from</span> <span class="s1">&#39;https://cdn.skypack.dev/@hotwired/turbo&#39;</span><span class="p">;</span>

  <span class="n">const</span> <span class="n">wsUrl</span> <span class="o">=</span> <span class="p">((</span><span class="n">window</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">protocol</span> <span class="o">===</span> <span class="s2">&quot;https:&quot;</span><span class="p">)</span> <span class="err">?</span> <span class="s2">&quot;wss://&quot;</span> <span class="p">:</span> <span class="s2">&quot;ws://&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">window</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">host</span> <span class="o">+</span> <span class="s2">&quot;/status/{{ job_id }}&quot;</span>

  <span class="n">document</span><span class="o">.</span><span class="n">eventSource</span> <span class="o">=</span> <span class="n">new</span> <span class="n">WebSocket</span><span class="p">(</span><span class="n">wsUrl</span><span class="p">);</span>
  <span class="n">connectStreamSource</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">eventSource</span><span class="p">);</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>


<p>This is a template that the server renders, which means the <code>{{ job_id }}</code> is
replaced by the actual job ID.</p>
<p>Once the page loads a WebSocket is connected to <code>/status/&lt;job_id&gt;</code> over which
the server can send Turbo Stream templates that update what is shown to the user.</p>
<p>The body of the status page contains a <code>&lt;div&gt;</code> element telling the user that
the document is being processed:</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;spinner-border&quot;</span> <span class="na">role=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;visually-hidden&quot;</span><span class="nt">&gt;</span>Processing...<span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>


<p>The WebSocket handler at <code>/status/&lt;job_id&gt;</code> then sends a message like the
following once the file has been converted:</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;turbo-stream</span> <span class="na">action=</span><span class="s">&quot;replace&quot;</span> <span class="na">target=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;template&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;status&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;p&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/documents/</span><span class="cp">{{</span> <span class="nv">job_id</span> <span class="cp">}}</span><span class="s">/output/document.pdf&quot;</span><span class="nt">&gt;</span>Download your PDF<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/template&gt;</span>
<span class="nt">&lt;/turbo-stream&gt;</span>
</pre></div>


<p>which replaces the DOM element with the ID <code>status</code>.</p>
<p>That is all there is to using Turbo Streams via a long running WebSocket.</p>
<p>The project I used this for is <a href="https://github.com/betatim/pdf-it">https://github.com/betatim/pdf-it</a>.</p>
  </article>
</article>

        </div>
      </div>

<div class="row justify-content-center pb-5">
  <div class="col-md-8">
    <footer>
      <div class="social">
          <a href="https://github.com/betatim"><i class="fa fa-github fa-2x"></i></a>
          <a href="https://twitter.com/betatim"><i class="fa fa-twitter fa-2x"></i></a>
          <a href="mailto:betatim@gmail.com"><i class="fa fa-envelope fa-2x"></i></a>
      </div>
      <div class="powered-by">
        Copyright Â© 2014-2020  - Tim Head
      </div>
    </footer>
  </div>
</div>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  </body>
</html>